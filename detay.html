<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faaliyet Detayı</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<header>
  <button onclick="history.back()" class="btn-secondary">← Geri</button>
  <h1>Faaliyet Detayı</h1>
  <button id="btnPdf" class="btn">PDF İndir</button>
</header>

<main id="detay" class="detay"></main>

<script>
function cleanNumber(v){ if(!v) return 0;
  let s=String(v).replace(/[^\d,.\-]/g,"");
  if(s.includes(",") && (s.split(",")[1]||"").length<=3){ s=s.replace(/\./g,"").replace(",","."); }
  else { s=s.replace(/\./g,""); }
  const n=parseFloat(s); return isNaN(n)?0:n;
}
const money = v => {
  const n=cleanNumber(v);
  return n ? n.toLocaleString("tr-TR") + " TL" : (v || "-");
};

const row = JSON.parse(localStorage.getItem("dsi_selected_row")||"{}");
const div = document.getElementById("detay");

if (!Object.keys(row).length) {
  div.innerHTML = "<p>Veri bulunamadı.</p>";
} else {
  let html = `<table>`;
  for (const [k,v] of Object.entries(row)) {
    const isMoney = /maliyet|harcama|ödenek|bedel|bakiye|tutar|keşif/i.test(k);
    html += `<tr><th>${k}</th><td>${isMoney ? money(v) : (v || "-")}</td></tr>`;
  }
  html += `</table>`;
  div.innerHTML = html;
}

document.getElementById("btnPdf").onclick = async ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  let y = 42;

  doc.setFont("helvetica","bold"); doc.setFontSize(14);
  doc.text("DSİ 2025 – Faaliyet Detayı", 40, y); y += 24;
  doc.setFont("helvetica","normal"); doc.setFontSize(10);

  for (const [k,v] of Object.entries(row)) {
    const isMoney = /maliyet|harcama|ödenek|bedel|bakiye|tutar|keşif/i.test(k);
    const val = isMoney ? money(v) : (v || "-");
    const text = `${k}: ${val}`;
    const lines = doc.splitTextToSize(text, 515);
    if (y + lines.length*14 > 800) { doc.addPage(); y = 42; }
    doc.text(lines, 40, y);
    y += lines.length*14 + 6;
  }
  doc.save("Faaliyet_Detayi.pdf");
};
</script>
</body>
</html>
