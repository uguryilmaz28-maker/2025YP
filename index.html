<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DSƒ∞ 2025 Yatƒ±rƒ±m Programƒ±</title>
<link rel="stylesheet" href="style.css"/>
<link rel="manifest" href="manifest.json"/>

<!-- Harita -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<!-- CSV Parse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()))
    .finally(() => navigator.serviceWorker.register('service-worker.js?v=2025-10-28-04').catch(()=>{}));
  });
}
</script>
</head>

<body>
<header>
  <h1>üíß DSƒ∞ 2025 Yatƒ±rƒ±m Programƒ±</h1>
  <div class="header-actions">
    <div class="metric">
      <label for="metric">Harita Metrik:</label>
      <select id="metric">
        <option value="REVIZE_ODENEK">Revize √ñdenek</option>
        <option value="TOPLAM_HARCAMA">Toplam Harcama</option>
        <option value="TOPLAM_MALIYET">Toplam Maliyet</option>
      </select>
    </div>
    <button id="toggleMap" class="btn-secondary">üó∫Ô∏è Harita</button>
    <button id="filterBtn" class="btn">Filtrele ‚öôÔ∏è</button>
  </div>
</header>

<section id="kpiPanel" class="kpi-panel">
  <div class="kpi"><div class="t">Toplam Maliyet</div><div class="v" id="k_maliyet">‚Äì</div></div>
  <div class="kpi"><div class="t">Toplam Harcama</div><div class="v" id="k_harcama">‚Äì</div></div>
  <div class="kpi"><div class="t">Revize √ñdenek</div><div class="v" id="k_revize">‚Äì</div></div>
  <div class="kpi"><div class="t">2025 Yƒ±lƒ± Harcamasƒ±</div><div class="v" id="k_yiliharcama">‚Äì</div></div>
  <div class="kpi"><div class="t">Bakiye</div><div class="v" id="k_bakiye">‚Äì</div></div>
  <div class="kpi"><div class="t">2025 Performans Hedefi</div><div class="v" id="k_hedef">‚Äì</div></div>
  <div class="kpi"><div class="t">Sulama (ha) Toplamƒ±</div><div class="v" id="k_sulama">‚Äì</div></div>
</section>

<div class="toolbar">
  <input id="q" placeholder="Ara... (faaliyet, il, daire vb.)"/>
  <div class="rowsize">
    <label>Sayfa boyutu:</label>
    <select id="rowsPerPage">
      <option>50</option>
      <option selected>100</option>
      <option>200</option>
      <option>500</option>
    </select>
  </div>
</div>

<section id="mapWrap" class="map-wrap hidden">
  <div id="map" class="map"></div>
  <div class="map-legend" id="mapLegend"></div>
</section>

<main id="list" class="grid"></main>
<div id="pagination" class="pagination"></div>

<!-- Fƒ∞LTRE PANELƒ∞ -->
<div id="filterPanel" class="filter-panel hidden">
  <h2>Filtrele</h2>
  <div id="filterContainer"></div>
  <div class="filter-actions">
    <button id="clearFilters" class="btn-secondary">T√ºm√ºn√º Temizle</button>
    <button id="applyFilters" class="btn">Tamam</button>
  </div>
</div>

<script>
const SHEET_ID  = "18dE07YFXAoUcLqAZ4lqCPD0XT1s_ZfwO";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
const FILTER_KEYS = ["PERFORMANS_DURUMU","DAIRE","HARCAMA_YUZDESI","YAPIM_SEKLI","BOLGE_NO","BOLGESEL_DURUM","CSBB_UST","HAVZA","IL"];
const KPI_KEYS = { MALIYET:"TOPLAM_MALIYET",HARCAMA:"TOPLAM_HARCAMA",REVIZE:"REVIZE_ODENEK",YIL_HARCAMA:"HARCAMA_2025",HEDEF:"HEDEF_2025",SULAMA:"SULAMA_HA",BAKIYE:"BAKIYE" };
const BAKIYE_MODE = "total";
let ALL=[],VIEW=[],PAGE=1,PAGE_SIZE=100,map,trLayer;

function normalizeHeader(h){
  if(!h) return "";
  const map={"ƒ∞":"I","I":"I","ƒ±":"i","≈û":"S","≈ü":"s","ƒû":"G","ƒü":"g","√ú":"U","√º":"u","√ñ":"O","√∂":"o","√á":"C","√ß":"c","√Ç":"A","√ä":"E"};
  let s=String(h).split("").map(ch=>map[ch]||ch).join("").toUpperCase().trim();
  if(/IL( |$)|IL ADI|ILI|YERI/.test(s)) return "IL";
  if(/HAVZA/.test(s)) return "HAVZA";
  if(/PERFORMANS DURUMU/.test(s)) return "PERFORMANS_DURUMU";
  if(/IS(TEN)? SORUMLU DAIRE/.test(s)) return "DAIRE";
  if(/YAPIM SEKLI|YAPIM YONTEMI/.test(s)) return "YAPIM_SEKLI";
  if(/BIRIM KODU|BOLGE NO/.test(s)) return "BOLGE_NO";
  if(/BOLGESEL DURUM/.test(s)) return "BOLGESEL_DURUM";
  if(/CSBB SEVIYE UST|CSIDB SEVIYE UST/.test(s)) return "CSBB_UST";
  if(/HARCAMA YUZDESI|GERCEKLESME/.test(s)) return "HARCAMA_YUZDESI";
  if(/TOPLAM MALIYET/.test(s)) return "TOPLAM_MALIYET";
  if(/TOPLAM HARCAMA/.test(s)) return "TOPLAM_HARCAMA";
  if(/REVIZE ODENEK/.test(s)) return "REVIZE_ODENEK";
  if(/2025 YILI HARCAMASI|2025 HARCAMASI/.test(s)) return "HARCAMA_2025";
  if(/2025 PERFORMANS HEDEFI/.test(s)) return "HEDEF_2025";
  if(/SULAMA.*HA/.test(s)) return "SULAMA_HA";
  if(/BAKIYE/.test(s)) return "BAKIYE";
  if(/FAAL.*ADI/.test(s)) return "TITLE";
  return s.replace(/[^A-Z0-9]+/g,"_");
}

function canonizeRow(row){
  if(!row) return {};
  const out={};
  for(const k in row){
    if(!k) continue;
    const key=normalizeHeader(k);
    if(key) out[key]=row[k];
  }
  return out;
}

function cleanNumber(v){
  if(!v) return 0;
  let s=String(v).trim().replace(/[^\d,.\-]/g,"");
  if(s.includes(",")&&(s.split(",")[1]||"").length<=3){ s=s.replace(/\./g,"").replace(",","."); }
  else s=s.replace(/\./g,"");
  const n=parseFloat(s);
  return isNaN(n)?0:n;
}
const fmt=n=>cleanNumber(n).toLocaleString("tr-TR");

async function load(){
  try{
    const csv=await fetch(SHEET_URL).then(r=>r.text());
    const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});
    ALL=(parsed.data||[]).map(canonizeRow);
    if(!ALL.length) throw new Error("Veri bo≈ü");
    buildFiltersUI();
    restoreFilters();
    applyFilters();
  }catch(e){
    console.error("Sheets y√ºklenemedi:",e);
    alert("Google Sheets baƒülantƒ±sƒ± okunamadƒ±!");
  }
}

function buildFiltersUI(){
  const box=document.getElementById("filterContainer");
  box.innerHTML="";
  const labels={PERFORMANS_DURUMU:"Performans Durumu",DAIRE:"ƒ∞≈üten Sorumlu Daire",HARCAMA_YUZDESI:"Harcama %",YAPIM_SEKLI:"Yapƒ±m ≈ûekli",BOLGE_NO:"B√∂lge No",BOLGESEL_DURUM:"B√∂lgesel Durum",CSBB_UST:"√áSBB Seviye √úst",HAVZA:"Havza",IL:"ƒ∞l"};
  FILTER_KEYS.forEach(k=>{
    const vals=[...new Set(ALL.map(r=>(r[k]||"").toString().trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'tr'));
    if(!vals.length) return;
    const id="f_"+k;
    const html=`<div class="filter-item"><label>${labels[k]||k}</label><select id="${id}"><option value="">T√ºm√º</option>${vals.map(v=>`<option>${v}</option>`).join("")}</select></div>`;
    box.insertAdjacentHTML("beforeend",html);
  });
}

function restoreFilters(){
  const qSaved=localStorage.getItem("q"); if(qSaved) document.getElementById("q").value=qSaved;
  const rpp=parseInt(localStorage.getItem("rowsPerPage")||"100",10);
  document.getElementById("rowsPerPage").value=rpp; PAGE_SIZE=rpp;
}

function applyFilters(){
  const get=id=>document.getElementById("f_"+id)?.value||"";
  const q=document.getElementById("q").value.toLowerCase().trim();
  VIEW=ALL.filter(r=>{
    return (!get("PERFORMANS_DURUMU")||r.PERFORMANS_DURUMU===get("PERFORMANS_DURUMU"))&&
           (!get("DAIRE")||r.DAIRE===get("DAIRE"))&&
           (!get("YAPIM_SEKLI")||r.YAPIM_SEKLI===get("YAPIM_SEKLI"))&&
           (!get("IL")||r.IL===get("IL"))&&
           (!get("HAVZA")||r.HAVZA===get("HAVZA"));
  });
  if(q) VIEW=VIEW.filter(r=>Object.values(r).some(v=>(v||"").toString().toLowerCase().includes(q)));
  PAGE=1;
  renderAll();
}

function renderAll(){ renderKPIs(VIEW); renderList(VIEW); updateMap(VIEW); }

function renderKPIs(rows){
  const sum=k=>rows.reduce((a,r)=>a+cleanNumber(r[k]),0);
  const m=sum("TOPLAM_MALIYET"),h=sum("TOPLAM_HARCAMA"),r=sum("REVIZE_ODENEK"),y=sum("HARCAMA_2025"),he=sum("HEDEF_2025"),s=sum("SULAMA_HA");
  const hasB=rows.some(r=>r.BAKIYE!=null&&String(r.BAKIYE).trim()!=="");
  const b=hasB?sum("BAKIYE"):rows.reduce((acc,r)=>acc+(cleanNumber(r.REVIZE_ODENEK)-cleanNumber(r.TOPLAM_HARCAMA)),0);
  document.getElementById("k_maliyet").textContent=fmt(m);
  document.getElementById("k_harcama").textContent=fmt(h);
  document.getElementById("k_revize").textContent=fmt(r);
  document.getElementById("k_yiliharcama").textContent=fmt(y);
  document.getElementById("k_hedef").textContent=fmt(he);
  document.getElementById("k_sulama").textContent=fmt(s);
  document.getElementById("k_bakiye").textContent=fmt(b);
}

function renderList(rows){
  const list=document.getElementById("list"); list.innerHTML="";
  const start=(PAGE-1)*PAGE_SIZE; const pageRows=rows.slice(start,start+PAGE_SIZE);
  pageRows.forEach(r=>{
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<h3>${r.TITLE||"-"}</h3><p><b>ƒ∞l:</b> ${r.IL||"-"} | <b>Revize:</b> ${fmt(r.REVIZE_ODENEK)} | <b>Harcama:</b> ${fmt(r.TOPLAM_HARCAMA)}</p>`;
    c.onclick=()=>{localStorage.setItem("dsi_selected_row",JSON.stringify(r));window.location.href="detay.html";};
    list.appendChild(c);
  });
}

function initMap(){
  if(map) return;
  map=L.map('map').setView([38.5,31.5],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:8}).addTo(map);
  fetch('https://raw.githubusercontent.com/cihadturhan/tr-geojson/master/geo/tr_with_cyprus.geojson')
  .then(r=>r.json()).then(geo=>{
    trLayer=L.geoJSON(geo,{style:{color:"#888",weight:1,fillOpacity:0.6}}).addTo(map);
    setupMapInteraction(); updateMap(VIEW);
  });
}

function setupMapInteraction(){
  if(!trLayer) return;
  trLayer.eachLayer(layer=>{
    layer.on('click',()=>{
      const il=(layer.feature.properties.name||"").toUpperCase();
      const sel=document.getElementById("f_IL");
      if(sel){ sel.value=il; applyFilters(); }
      document.getElementById("mapLegend").innerHTML=`<b>${il}</b> ili se√ßildi.`;
    });
  });
}

function updateMap(rows){
  if(!trLayer) return;
  const metric=document.getElementById("metric").value||"REVIZE_ODENEK";
  const agg={}; rows.forEach(r=>{const il=(r.IL||"").toUpperCase(); const v=cleanNumber(r[metric]); if(!il)return; agg[il]=(agg[il]||0)+v;});
  const vals=Object.values(agg); const max=vals.length?Math.max(...vals):1;
  trLayer.eachLayer(l=>{
    const n=(l.feature.properties.name||"").toUpperCase();
    if(n.includes("KIBRIS")){ l.setStyle({fillColor:"#ccc",color:"#666",fillOpacity:0.5}); return; }
    const v=agg[n]||0; const ratio=Math.sqrt(v/max);
    const color=v===0?"#eee":`rgba(12,115,67,${0.2+0.6*ratio})`;
    l.setStyle({fillColor:color});
    l.bindTooltip(`${l.feature.properties.name}: ${fmt(v)} (${metric})`,{sticky:true});
  });
}

document.getElementById("filterBtn").onclick=()=>document.getElementById("filterPanel").classList.toggle("hidden");
document.getElementById("applyFilters").onclick=()=>{document.getElementById("filterPanel").classList.add("hidden");applyFilters();};
document.getElementById("clearFilters").onclick=()=>{document.querySelectorAll("#filterContainer select").forEach(s=>s.value="");document.getElementById("q").value="";applyFilters();};
document.getElementById("toggleMap").onclick=()=>{document.getElementById("mapWrap").classList.toggle("hidden");initMap();setTimeout(()=>map&&map.invalidateSize(),200);};
document.getElementById("metric").onchange=()=>updateMap(VIEW);
document.getElementById("q").oninput=()=>applyFilters();
document.getElementById("rowsPerPage").onchange=e=>{PAGE_SIZE=parseInt(e.target.value)||100;renderList(VIEW);};
load();
</script>
</body>
</html>
