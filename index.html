<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DSÄ° 2025 YatÄ±rÄ±m ProgramÄ±</title>
<link rel="stylesheet" href="style.css"/>
<link rel="manifest" href="manifest.json"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
if ('serviceWorker' in navigator) {
Â  window.addEventListener('load', () => {
Â  Â  navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()))
Â  Â  .finally(() => navigator.serviceWorker.register('service-worker.js?v=2025-10-28-04').catch(()=>{}));
Â  });
}
</script>
</head>

<body>
<header>
Â  <h1>ğŸ’§ DSÄ° 2025 YatÄ±rÄ±m ProgramÄ±</h1>
Â  <div class="header-actions">
Â  Â  <div class="metric">
Â  Â  Â  <label for="metric">Harita Metrik:</label>
Â  Â  Â  <select id="metric">
Â  Â  Â  Â  <option value="REVIZE_ODENEK">Revize Ã–denek</option>
Â  Â  Â  Â  <option value="TOPLAM_HARCAMA">Toplam Harcama</option>
Â  Â  Â  Â  <option value="TOPLAM_MALIYET">Toplam Maliyet</option>
Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <button id="toggleMap" class="btn-secondary">ğŸ—ºï¸ Harita</button>
Â  Â  <button id="filterBtn" class="btn">Filtrele âš™ï¸</button>
Â  </div>
</header>

<section id="kpiPanel" class="kpi-panel">
Â  <div class="kpi"><div class="t">Toplam Maliyet</div><div class="v" id="k_maliyet">â€“</div></div>
Â  <div class="kpi"><div class="t">Toplam Harcama</div><div class="v" id="k_harcama">â€“</div></div>
Â  <div class="kpi"><div class="t">Revize Ã–denek</div><div class="v" id="k_revize">â€“</div></div>
Â  <div class="kpi"><div class="t">2025 YÄ±lÄ± HarcamasÄ±</div><div class="v" id="k_yiliharcama">â€“</div></div>
Â  <div class="kpi"><div class="t">Bakiye</div><div class="v" id="k_bakiye">â€“</div></div>
Â  <div class="kpi"><div class="t">2025 Performans Hedefi</div><div class="v" id="k_hedef">â€“</div></div>
Â  <div class="kpi"><div class="t">Sulama (ha) ToplamÄ±</div><div class="v" id="k_sulama">â€“</div></div>
</section>

<div class="toolbar">
Â  <input id="q" placeholder="Ara... (faaliyet, il, daire vb.)"/>
Â  <div class="rowsize">
Â  Â  <label>Sayfa boyutu:</label>
Â  Â  <select id="rowsPerPage">
Â  Â  Â  <option>50</option>
Â  Â  Â  <option selected>100</option>
Â  Â  Â  <option>200</option>
Â  Â  Â  <option>500</option>
Â  Â  </select>
Â  </div>
</div>

<section id="mapWrap" class="map-wrap hidden">
Â  <div id="map" class="map"></div>
Â  <div class="map-legend" id="mapLegend"></div>
</section>

<main id="list" class="grid"></main>
<div id="pagination" class="pagination"></div>

<div id="filterPanel" class="filter-panel hidden">
Â  <h2>Filtrele</h2>
Â  <div id="filterContainer"></div>
Â  <div class="filter-actions">
Â  Â  <button id="clearFilters" class="btn-secondary">TÃ¼mÃ¼nÃ¼ Temizle</button>
Â  Â  <button id="applyFilters" class="btn">Tamam</button>
Â  </div>
</div>

<script>
const SHEET_IDÂ  = "18dE07YFXAoUcLqAZ4lqCPD0XT1s_ZfwO";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
const FILTER_KEYS = ["PERFORMANS_DURUMU","DAIRE","HARCAMA_YUZDESI","YAPIM_SEKLI","BOLGE_NO","BOLGESEL_DURUM","CSBB_UST","HAVZA","IL"];
const KPI_KEYS = { MALIYET:"TOPLAM_MALIYET",HARCAMA:"TOPLAM_HARCAMA",REVIZE:"REVIZE_ODENEK",YIL_HARCAMA:"HARCAMA_2025",HEDEF:"HEDEF_2025",SULAMA:"SULAMA_HA",BAKIYE:"BAKIYE" };
const BAKIYE_MODE = "total";
let ALL=[],VIEW=[],PAGE=1,PAGE_SIZE=100,map,trLayer;

function normalizeHeader(h){
Â  if(!h) return "";
Â  const map={"Ä°":"I","I":"I","Ä±":"i","Å":"S","ÅŸ":"s","Ä":"G","ÄŸ":"g","Ãœ":"U","Ã¼":"u","Ã–":"O","Ã¶":"o","Ã‡":"C","Ã§":"c","Ã‚":"A","ÃŠ":"E"};
Â  let s=String(h).split("").map(ch=>map[ch]||ch).join("").toUpperCase().trim();
Â  if(/IL( |$)|IL ADI|ILI|YERI/.test(s)) return "IL";
Â  if(/HAVZA/.test(s)) return "HAVZA";
Â  if(/PERFORMANS DURUMU/.test(s)) return "PERFORMANS_DURUMU";
Â  if(/IS(TEN)? SORUMLU DAIRE/.test(s)) return "DAIRE";
Â  if(/YAPIM SEKLI|YAPIM YONTEMI/.test(s)) return "YAPIM_SEKLI";
Â  if(/BIRIM KODU|BOLGE NO/.test(s)) return "BOLGE_NO";
Â  if(/BOLGESEL DURUM/.test(s)) return "BOLGESEL_DURUM";
Â  if(/CSBB SEVIYE UST|CSIDB SEVIYE UST/.test(s)) return "CSBB_UST";
Â  if(/HARCAMA YUZDESI|GERCEKLESME/.test(s)) return "HARCAMA_YUZDESI";
Â  if(/TOPLAM MALIYET/.test(s)) return "TOPLAM_MALIYET";
Â  if(/TOPLAM HARCAMA/.test(s)) return "TOPLAM_HARCAMA";
Â  if(/REVIZE ODENEK/.test(s)) return "REVIZE_ODENEK";
Â  if(/2025 YILI HARCAMASI|2025 HARCAMASI/.test(s)) return "HARCAMA_2025";
Â  if(/2025 PERFORMANS HEDEFI/.test(s)) return "HEDEF_2025";
Â  if(/SULAMA.*HA/.test(s)) return "SULAMA_HA";
Â  if(/BAKIYE/.test(s)) return "BAKIYE";
Â  if(/FAAL.*ADI/.test(s)) return "TITLE";
// YÃœKLENÄ°CÄ° BÄ°LGÄ°SÄ° EKLENDÄ°
Â  if(/YUKLENICI|MUTEAHHIT/.test(s)) return "YUKLENICI_BILGISI";
Â  return s.replace(/[^A-Z0-9]+/g,"_");
}

function canonizeRow(row){
Â  if(!row) return {};
Â  const out={};
Â  for(const k in row){
Â  Â  if(!k) continue;
Â  Â  const key=normalizeHeader(k);
Â  Â  if(key) out[key]=row[k];
Â  }
Â  return out;
}

function cleanNumber(v){
Â  if(!v) return 0;
Â  let s=String(v).trim().replace(/[^\d,.\-]/g,"");
Â  if(s.includes(",")&&(s.split(",")[1]||"").length<=3){ s=s.replace(/\./g,"").replace(",","."); }
Â  else s=s.replace(/\./g,"");
Â  const n=parseFloat(s);
Â  return isNaN(n)?0:n;
}
const fmt=n=>cleanNumber(n).toLocaleString("tr-TR");

async function load(){
Â  try{
Â  Â  const csv=await fetch(SHEET_URL).then(r=>r.text());
Â  Â  const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});
Â  Â  ALL=(parsed.data||[]).map(canonizeRow);
Â  Â  if(!ALL.length) throw new Error("Veri boÅŸ");
Â  Â  buildFiltersUI();
Â  Â  restoreFilters();
Â  Â  applyFilters();
Â  }catch(e){
Â  Â  console.error("Sheets yÃ¼klenemedi:",e);
Â  Â  alert("Google Sheets baÄŸlantÄ±sÄ± okunamadÄ±!");
Â  }
}

function buildFiltersUI(){
Â  const box=document.getElementById("filterContainer");
Â  box.innerHTML="";
Â  const labels={PERFORMANS_DURUMU:"Performans Durumu",DAIRE:"Ä°ÅŸten Sorumlu Daire",HARCAMA_YUZDESI:"Harcama %",YAPIM_SEKLI:"YapÄ±m Åekli",BOLGE_NO:"BÃ¶lge No",BOLGESEL_DURUM:"BÃ¶lgesel Durum",CSBB_UST:"Ã‡SBB Seviye Ãœst",HAVZA:"Havza",IL:"Ä°l"};
Â  FILTER_KEYS.forEach(k=>{
Â  Â  const vals=[...new Set(ALL.map(r=>(r[k]||"").toString().trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'tr'));
Â  Â  if(!vals.length) return;
Â  Â  const id="f_"+k;
Â  Â  const html=`<div class="filter-item"><label>${labels[k]||k}</label><select id="${id}"><option value="">TÃ¼mÃ¼</option>${vals.map(v=>`<option>${v}</option>`).join("")}</select></div>`;
Â  Â  box.insertAdjacentHTML("beforeend",html);
Â  });
}

function restoreFilters(){
Â  const qSaved=localStorage.getItem("q"); if(qSaved) document.getElementById("q").value=qSaved;
Â  const rpp=parseInt(localStorage.getItem("rowsPerPage")||"100",10);
Â  document.getElementById("rowsPerPage").value=rpp; PAGE_SIZE=rpp;
}

function applyFilters(){
Â  const get=id=>document.getElementById("f_"+id)?.value||"";
Â  const q=document.getElementById("q").value.toLowerCase().trim();
Â  VIEW=ALL.filter(r=>{
Â  Â  return (!get("PERFORMANS_DURUMU")||r.PERFORMANS_DURUMU===get("PERFORMANS_DURUMU"))&&
Â  Â  Â  Â  Â  Â (!get("DAIRE")||r.DAIRE===get("DAIRE"))&&
Â  Â  Â  Â  Â  Â (!get("YAPIM_SEKLI")||r.YAPIM_SEKLI===get("YAPIM_SEKLI"))&&
Â  Â  Â  Â  Â  Â (!get("IL")||r.IL===get("IL"))&&
Â  Â  Â  Â  Â  Â (!get("HAVZA")||r.HAVZA===get("HAVZA"));
Â  });
Â  if(q) VIEW=VIEW.filter(r=>Object.values(r).some(v=>(v||"").toString().toLowerCase().includes(q)));
Â  PAGE=1;
Â  renderAll();
}

function renderAll(){ renderKPIs(VIEW); renderList(VIEW); updateMap(VIEW); }

function renderKPIs(rows){
Â  const sum=k=>rows.reduce((a,r)=>a+cleanNumber(r[k]),0);
Â  const m=sum("TOPLAM_MALIYET"),h=sum("TOPLAM_HARCAMA"),r=sum("REVIZE_ODENEK"),y=sum("HARCAMA_2025"),he=sum("HEDEF_2025"),s=sum("SULAMA_HA");
Â  const hasB=rows.some(r=>r.BAKIYE!=null&&String(r.BAKIYE).trim()!=="");
Â  const b=hasB?sum("BAKIYE"):rows.reduce((acc,r)=>acc+(cleanNumber(r.REVIZE_ODENEK)-cleanNumber(r.TOPLAM_HARCAMA)),0);
Â  document.getElementById("k_maliyet").textContent=fmt(m);
Â  document.getElementById("k_harcama").textContent=fmt(h);
Â  document.getElementById("k_revize").textContent=fmt(r);
Â  document.getElementById("k_yiliharcama").textContent=fmt(y);
Â  document.getElementById("k_hedef").textContent=fmt(he);
Â  document.getElementById("k_sulama").textContent=fmt(s);
Â  document.getElementById("k_bakiye").textContent=fmt(b);
}

function renderList(rows){
Â  const list=document.getElementById("list"); list.innerHTML="";
Â  const start=(PAGE-1)*PAGE_SIZE; const pageRows=rows.slice(start,start+PAGE_SIZE);
Â  pageRows.forEach(r=>{
Â  Â  const c=document.createElement("div"); c.className="card";
    // YÃ¼klenici Bilgisi Eklendi
    const yuklenici = r.YUKLENICI_BILGISI || "-";
    
Â  Â  c.innerHTML=`<h3>${r.TITLE||"-"}</h3>
    <p class="card-contractor"><b>YÃ¼klenici:</b> ${yuklenici}</p>
    <p><b>Ä°l:</b> ${r.IL||"-"} | <b>Revize:</b> ${fmt(r.REVIZE_ODENEK)} | <b>Harcama:</b> ${fmt(r.TOPLAM_HARCAMA)}</p>`;
    
Â  Â  c.onclick=()=>{localStorage.setItem("dsi_selected_row",JSON.stringify(r));window.location.href="detay.html";};
Â  Â  list.appendChild(c);
Â  });
}

function initMap(){
Â  if(map) return;
Â  map=L.map('map').setView([38.5,31.5],6);
Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:8}).addTo(map);
Â  fetch('https://raw.githubusercontent.com/cihadturhan/tr-geojson/master/geo/tr_with_cyprus.geojson')
Â  .then(r=>r.json()).then(geo=>{
Â  Â  trLayer=L.geoJSON(geo,{style:{color:"#888",weight:1,fillOpacity:0.6}}).addTo(map);
Â  Â  setupMapInteraction(); updateMap(VIEW);
Â  });
}

function setupMapInteraction(){
Â  if(!trLayer) return;
Â  trLayer.eachLayer(layer=>{
Â  Â  layer.on('click',()=>{
Â  Â  Â  const il=(layer.feature.properties.name||"").toUpperCase();
Â  Â  Â  const sel=document.getElementById("f_IL");
Â  Â  Â  if(sel){ sel.value=il; applyFilters(); }
Â  Â  Â  document.getElementById("mapLegend").innerHTML=`<b>${il}</b> ili seÃ§ildi.`;
Â  Â  });
Â  });
}

function updateMap(rows){
Â  if(!trLayer) return;
Â  const metric=document.getElementById("metric").value||"REVIZE_ODENEK";
Â  const agg={}; rows.forEach(r=>{const il=(r.IL||"").toUpperCase(); const v=cleanNumber(r[metric]); if(!il)return; agg[il]=(agg[il]||0)+v;});
Â  const vals=Object.values(agg); const max=vals.length?Math.max(...vals):1;
Â  trLayer.eachLayer(l=>{
Â  Â  const n=(l.feature.properties.name||"").toUpperCase();
Â  Â  if(n.includes("KIBRIS")){ l.setStyle({fillColor:"#ccc",color:"#666",fillOpacity:0.5}); return; }
Â  Â  const v=agg[n]||0; const ratio=Math.sqrt(v/max);
Â  Â  const color=v===0?"#eee":`rgba(12,115,67,${0.2+0.6*ratio})`;
Â  Â  l.setStyle({fillColor:color});
Â  Â  l.bindTooltip(`${l.feature.properties.name}: ${fmt(v)} (${metric})`,{sticky:true});
Â  });
}

document.getElementById("filterBtn").onclick=()=>document.getElementById("filterPanel").classList.toggle("hidden");
document.getElementById("applyFilters").onclick=()=>{document.getElementById("filterPanel").classList.add("hidden");applyFilters();};
document.getElementById("clearFilters").onclick=()=>{document.querySelectorAll("#filterContainer select").forEach(s=>s.value="");document.getElementById("q").value="";applyFilters();};
document.getElementById("toggleMap").onclick=()=>{document.getElementById("mapWrap").classList.toggle("hidden");initMap();setTimeout(()=>map&&map.invalidateSize(),200);};
document.getElementById("metric").onchange=()=>updateMap(VIEW);
document.getElementById("q").oninput=()=>applyFilters();
document.getElementById("rowsPerPage").onchange=e=>{PAGE_SIZE=parseInt(e.target.value)||100;renderList(VIEW);};
load();
</script>
</body>
</html>