<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DSƒ∞ 2025 Yatƒ±rƒ±m Programƒ±</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<header>
  <h1>üíß DSƒ∞ 2025 Yatƒ±rƒ±m Programƒ±</h1>
  <button id="filterBtn" class="btn">Filtrele ‚öôÔ∏è</button>
</header>

<section class="kpi-panel">
  <div class="kpi"><div class="t">Toplam Maliyet</div><div class="v" id="k_maliyet">‚Äì</div></div>
  <div class="kpi"><div class="t">Toplam Harcama</div><div class="v" id="k_harcama">‚Äì</div></div>
  <div class="kpi"><div class="t">Revize √ñdenek</div><div class="v" id="k_revize">‚Äì</div></div>
  <div class="kpi"><div class="t">2025 Yƒ±lƒ± Harcamasƒ±</div><div class="v" id="k_yiliharcama">‚Äì</div></div>
  <div class="kpi"><div class="t">Bakiye</div><div class="v" id="k_bakiye">‚Äì</div></div>
  <div class="kpi"><div class="t">2025 Performans Hedefi</div><div class="v" id="k_hedef">‚Äì</div></div>
  <div class="kpi"><div class="t">Sulama (ha) Toplamƒ±</div><div class="v" id="k_sulama">‚Äì</div></div>
</section>

<div class="toolbar">
  <input id="q" placeholder="Ara... (faaliyet, il, daire vb.)"/>
  <div class="rowsize">
    <label>Sayfa boyutu:</label>
    <select id="rowsPerPage">
      <option>50</option>
      <option selected>100</option>
      <option>200</option>
      <option>500</option>
    </select>
  </div>
</div>

<main id="list" class="grid"></main>
<div id="pagination" class="pagination"></div>

<div id="filterPanel" class="filter-panel hidden">
  <h2>Filtrele</h2>
  <div id="filterContainer"></div>
  <div class="filter-actions">
    <button id="clearFilters" class="btn-secondary">T√ºm√ºn√º Temizle</button>
    <button id="applyFilters" class="btn">Tamam</button>
  </div>
</div>

<script>
const SHEET_ID  = "18dE07YFXAoUcLqAZ4lqCPD0XT1s_ZfwO";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
const FILTER_KEYS = ["PERFORMANS_DURUMU","DAIRE","HARCAMA_YUZDESI","YAPIM_SEKLI","BOLGE_NO","BOLGESEL_DURUM","CSBB_UST","HAVZA","IL"];
const KPI = { MALIYET:"TOPLAM_MALIYET", HARCAMA:"TOPLAM_HARCAMA", REVIZE:"REVIZE_ODENEK", YIL:"HARCAMA_2025", HEDEF:"HEDEF_2025", SULAMA:"SULAMA_HA" };

function normalizeHeader(h){
  if(!h) return "";
  const map={"ƒ∞":"I","I":"I","ƒ±":"i","≈û":"S","≈ü":"s","ƒû":"G","ƒü":"g","√ú":"U","√º":"u","√ñ":"O","√∂":"o","√á":"C","√ß":"c"};
  let s=String(h).replace(/\r|\n/g," ").replace(/\s+/g," ").trim();
  s=s.split("").map(ch=>map[ch]||ch).join("").toUpperCase();
  if (/FAAL[Iƒ∞]YET(\s*ADI)?/.test(s) || /IS(IN)?\s*ADI/.test(s) || /ƒ∞≈û(\s*ƒ∞N)?(\s*ADI)?/.test(s) || /PROJE(\s*ADI)?/.test(s)) return "TITLE";
  if (/IL( |$)|IL ADI|ILI|YERI/.test(s)) return "IL";
  if (/HAVZA/.test(s)) return "HAVZA";
  if (/PERFORMANS DURUMU/.test(s)) return "PERFORMANS_DURUMU";
  if (/IS(TEN)? SORUMLU DAIRE/.test(s)) return "DAIRE";
  if (/YAPIM SEKLI|YAPIM YONTEMI/.test(s)) return "YAPIM_SEKLI";
  if (/(BIRIM KODU|BOLGE NO)/.test(s)) return "BOLGE_NO";
  if (/BOLGESEL DURUM/.test(s)) return "BOLGESEL_DURUM";
  if (/(CSBB|CSIDB).*SEVIYE UST/.test(s)) return "CSBB_UST";
  if (/HARCAMA YUZDESI|GERCEKLESME/.test(s)) return "HARCAMA_YUZDESI";
  if (/TOPLAM MALIYET|YILI FIYATLARIYLA TOPLAM MALIYET/.test(s)) return "TOPLAM_MALIYET";
  if (/TOPLAM HARCAMA|YILI FIYATLARIYLA TOPLAM HARCAMA/.test(s)) return "TOPLAM_HARCAMA";
  if (/REVIZE ODENEK/.test(s)) return "REVIZE_ODENEK";
  if (/2025.*HARCAMASI/.test(s)) return "HARCAMA_2025";
  if (/2025.*PERFORMANS HEDEFI/.test(s)) return "HEDEF_2025";
  if (/SULAMA.*HA/.test(s)) return "SULAMA_HA";
  if (/BAKIYE/.test(s)) return "BAKIYE";
  if (/YUKLENICI|MUTEAHHIT/.test(s)) return "YUKLENICI_BILGISI";
  return s.replace(/[^A-Z0-9]+/g,"_").replace(/^_|_$/g,"");
}

function canonizeRow(row){
  const out={};
  for(const k in row){
    const key=normalizeHeader(k);
    out[key]=row[k];
  }
  if(!out.TITLE){
    for(const k in row){ const nk = normalizeHeader(k); if(/FAAL[Iƒ∞]YET/.test(nk) || /ƒ∞≈û/.test(nk)){ out.TITLE = row[k]; break; } }
  }
  return out;
}

function cleanNumber(v){
  if(v===undefined||v===null||v==="") return 0;
  let s=String(v).trim().replace(/[^\d,.-]/g,"");
  if (s.includes(",") && (s.split(",")[1]||"").length<=3) s=s.replace(/\./g,"").replace(",", ".");
  else s=s.replace(/\./g,"");
  const n=parseFloat(s);
  return isNaN(n)?0:n;
}
const fmt=n=>cleanNumber(n).toLocaleString("tr-TR");

let ALL=[],VIEW=[],PAGE=1,PAGE_SIZE=100;

async function load(){
  try{
    const csv = await fetch(SHEET_URL, {cache: "no-store"}).then(r=>r.text());
    const parsed = Papa.parse(csv, { header:true, skipEmptyLines:true });
    ALL = (parsed.data||[]).map(canonizeRow);
    VIEW=[...ALL];
    buildFiltersUI(); applyFilters();
  }catch(e){ console.error(e); alert("Google Sheets verisi okunamadƒ±. Payla≈üƒ±mƒ± kontrol edin."); }
}

function buildFiltersUI(){
  const labels={PERFORMANS_DURUMU:"Performans Durumu",DAIRE:"ƒ∞≈üten Sorumlu Daire",HARCAMA_YUZDESI:"Harcama %",YAPIM_SEKLI:"Yapƒ±m ≈ûekli",BOLGE_NO:"B√∂lge No",BOLGESEL_DURUM:"B√∂lgesel Durum",CSBB_UST:"√áSBB Seviye √úst",HAVZA:"Havza",IL:"ƒ∞l"};
  const box=document.getElementById("filterContainer"); box.innerHTML="";
  FILTER_KEYS.forEach(k=>{
    const vals=[...new Set(ALL.map(r=>(r[k]||"").toString().trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'tr'));
    if(!vals.length) return;
    const id="f_"+k;
    box.insertAdjacentHTML("beforeend",`<div class="filter-item"><label>${labels[k]||k}</label><select id="${id}"><option value="">T√ºm√º</option>${vals.map(v=>`<option>${v}</option>`).join("")}</select></div>`);
  });
}

function applyFilters(){
  const get=id=>document.getElementById("f_"+id)?.value||"";
  const q=document.getElementById("q").value.toLowerCase().trim();
  VIEW=ALL.filter(r=>{
    return (!get("PERFORMANS_DURUMU")||r.PERFORMANS_DURUMU===get("PERFORMANS_DURUMU"))&&
           (!get("DAIRE")||r.DAIRE===get("DAIRE"))&&
           (!get("HARCAMA_YUZDESI")||r.HARCAMA_YUZDESI===get("HARCAMA_YUZDESI"))&&
           (!get("YAPIM_SEKLI")||r.YAPIM_SEKLI===get("YAPIM_SEKLI"))&&
           (!get("BOLGE_NO")||r.BOLGE_NO===get("BOLGE_NO"))&&
           (!get("BOLGESEL_DURUM")||r.BOLGESEL_DURUM===get("BOLGESEL_DURUM"))&&
           (!get("CSBB_UST")||r.CSBB_UST===get("CSBB_UST"))&&
           (!get("HAVZA")||r.HAVZA===get("HAVZA"))&&
           (!get("IL")||r.IL===get("IL"));
  });
  if(q) VIEW=VIEW.filter(r=>Object.values(r).some(v=>(v??"").toString().toLowerCase().includes(q)));
  PAGE=1; renderAll();
}

function renderKPIs(){
  const sum=k=>VIEW.reduce((a,r)=>a+cleanNumber(r[k]),0);
  const m=sum("TOPLAM_MALIYET"),h=sum("TOPLAM_HARCAMA"),r=sum("REVIZE_ODENEK"),y=sum("HARCAMA_2025"),he=sum("HEDEF_2025"),s=sum("SULAMA_HA");
  const b=r-h;
  document.getElementById("k_maliyet").textContent=fmt(m);
  document.getElementById("k_harcama").textContent=fmt(h);
  document.getElementById("k_revize").textContent=fmt(r);
  document.getElementById("k_yiliharcama").textContent=fmt(y);
  document.getElementById("k_hedef").textContent=fmt(he);
  document.getElementById("k_sulama").textContent=fmt(s);
  document.getElementById("k_bakiye").textContent=fmt(b);
}

function renderList(){
  const list=document.getElementById("list"); list.innerHTML="";
  const start=(PAGE-1)*PAGE_SIZE; const rows=VIEW.slice(start,start+PAGE_SIZE);
  rows.forEach(r=>{
    const title=r.TITLE||r.FAALIYET_ADI||r.FAALIYET||r["IS ADI"]||r["ISIN ADI"]||r["ƒ∞≈û ADI"]||r["ƒ∞≈ûƒ∞N ADI"]||"-";
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<h3>${title}</h3>
    <p><b>ƒ∞l:</b> ${r.IL||"-"} ‚Ä¢ <b>B√∂lge:</b> ${r.BOLGE_NO||"-"}</p>
    <p><b>Revize:</b> ${fmt(r.REVIZE_ODENEK)} ‚Ä¢ <b>Harcama:</b> ${fmt(r.TOPLAM_HARCAMA)}</p>`;
    list.appendChild(c);
  });
  const pag=document.getElementById("pagination"); pag.innerHTML="";
  const totalPages=Math.max(1,Math.ceil(VIEW.length/PAGE_SIZE));
  for(let i=1;i<=totalPages;i++){
    const b=document.createElement("button"); b.textContent=i;
    if(i===PAGE) b.classList.add("active");
    b.onclick=()=>{PAGE=i;renderList();window.scrollTo({top:0,behavior:"smooth"});};
    pag.appendChild(b);
  }
}

function renderAll(){ renderKPIs(); renderList(); }

document.getElementById("filterBtn").onclick=()=>document.getElementById("filterPanel").classList.toggle("hidden");
document.getElementById("applyFilters").onclick=()=>{document.getElementById("filterPanel").classList.add("hidden");applyFilters();};
document.getElementById("clearFilters").onclick=()=>{document.querySelectorAll("#filterContainer select").forEach(s=>s.value="");document.getElementById("q").value="";applyFilters();};
document.getElementById("q").oninput=applyFilters;
document.getElementById("rowsPerPage").onchange=e=>{PAGE_SIZE=parseInt(e.target.value)||100;renderList();};

load();
</script>
</body>
</html>
